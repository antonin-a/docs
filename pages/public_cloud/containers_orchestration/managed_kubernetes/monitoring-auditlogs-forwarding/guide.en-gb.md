---
title: Managed Kubernetes Service Audit Logs Fowarding to Log Data Platform
excerpt: 'Find out how to forward audit logs from an OVH Managed Kubernetes Service (MKS) cluster to Logs Data Platform (LDP) - [Open Beta]'
updated: 2023-11-16
---
> [!warning]
>This feature is currently available in Beta. It is made available without SLA under OVHcloud Beta Terms and the API may evolve slightly in the future.


## Objective

In this tutorial, you will learn how to enable the forwarding of the audit logs of your OVHcloud Managed Kubernetes cluster to Logs Data Platform, a platform that helps you store, archive, query and visualize your logs.

To discover Logs Data Platform before continuing this guide, please refer to [this documentation.](https://help.ovhcloud.com/csm/en-gb-logs-data-platform-introduction?id=kb_article_view&sysparm_article=KB0058312)

## Glossary

**Logs Data Platform:** fully managed and secured log management platform proposed by OVHcloud. Find more information on the [Logs Data Platform service page](https://www.ovhcloud.com/en-ie/logs-data-platform/).

**Logs forwarding:** feature integrated in an OVHcloud product to forward logs from its services to a data stream of an LDP account in the same OVHcloud account. The feature has to be enabled by the customer per service ressource.

**Stream** : a logical partition of logs that you create in an LDP account that you will use when ingesting, visualizing or querying your logs. Multiple sources can be stored in the same data stream, and it is the unit for defining a logs pipeline (retention policy, archiving, live streaming...), access rights and alert policies.

**Subscription** : when enabling the logs forwarding for a given OVHcloud service to a given LDP data stream, a subscription is created and attached to the data stream for further management by the customer.

**Request stage and audit level** : audit records begin their lifecycle inside the kube-apiserver component. Each request on each stage of its execution generates an audit event, which is then pre-processed according to the policy defined by the OVHcloud Managed Kubernetes Service. This policy defines which audit events as well as which audit level (meaning which events data) are forwarded through the Audit logs of your Kubernetes cluster. For more details, refer to the [Kubernetes Auditing documentation](https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/).




## Prerequisites

To follow this guide, first you will need:

- a Logs Data Platform (LDP) account with at least one active stream configured. [This guide](https://help.ovhcloud.com/csm/en-gb-logs-data-platform-quick-start?id=kb_article_view&sysparm_article=KB0037679) will walk you through all the necessary steps.
- an up-and-running Managed Kubernetes Service (K8s) cluster. [This guide](https://help.ovhcloud.com/csm/en-public-cloud-kubernetes-create-cluster?id=kb_article_view&sysparm_article=KB0049685) will walk you through the steps as well.

Both LDP account and MKS cluster must belong to the same OVHcloud account

## Instructions

### What are audit logs of a Managed Kubernetes cluster?

Managed Kubernetes Service audit logs provide a security-relevant, chronological set of records documenting the sequence of actions in your cluster.

The cluster audits the activities generated by users, by applications that use the Kubernetes API, and by Kubernetes control plane itself. Auditing allows cluster administrators to know what happened, when, who initiated it, from where, on what did it happen and to where was it going. For further details about cluster audits, refer to the [Kubernetes auditing](https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/) documentation.

> [!warning]
>Managed Kubernetes Audit Logs does NOT include logs of your applications that are running on your Kubernetes pods. To also retrieve your data plan logs in one of your Logs Data Platform's data stream follow the guide: [Pushing logs from a Kubernetes cluster to Logs Data Platform using Fluent Bit](https://help.ovhcloud.com/csm/fr-logs-data-platform-kubernetes-fluent-bit?id=kb_article_view&sysparm_article=KB0037665)

The OVHcloud Managed Kubernetes Service has defined audit policy, enabling you to retrieve logs pertaining to:

- requests to authorization resources to help troubleshoot authentication issues
- configmap and secret changes in all namespaces at the Metadata audit level
- changes to resources at RequestResponse level (maximum verbosity) to create, patch, update and delete verbs
- changes to resources at Request level for other verbs
- all other requests at the Metadata level

Note:

- No logs for requests by the "system:kube-proxy" on endpoints or services
- Low level of verbosity (level Metadata) for endpoints containing sensitive data like tokenreview
- No logs for any request in the RequestReceived stage
- No logs for health checks and requests on apiserver metrics

For details about information capture in Kubernetes Audit logs you can refer to the Kubernetes [public documentation.](https://kubernetes.io/docs/reference/config-api/apiserver-audit.v1/)

Here is an example of an audit log generated by a Kubernetes cluster. Please note that the example is not exhaustive.

```
{
   "kind":"Event",
   "apiVersion":"audit.k8s.io/v1",
   "level":"Metadata",
   "auditID":"XXXXXXX-XXXX-XXXX-XXXX-XXXXXXXX",
   "stage":"ResponseStarted",
   "requestURI":"/api/v1/namespaces/searching-worker/configmaps?......",
   "verb":"watch",
   "user":{
      "username":"system:node:search-workers-node-81097c",
      "groups":[
         "system:nodes",
         "system:authenticated"
      ]
   },
   "sourceIPs":[
      "10.10.0.43"
   ],
   "userAgent":"kubelet/v1.26.4 (linux/amd64) kubernetes/f89670c",
   "objectRef":{
      "resource":"configmaps",
      "namespace":"searching-worker",
      "name":"kube-root-ca.crt",
      "apiVersion":"v1"
   },
   "responseStatus":{
      "metadata":{

      },
      "code":200
   },
   "requestReceivedTimestamp":"20xx-11-30T11:59:06.428015Z",
   "stageTimestamp":"20xx-11-30T11:59:06.428962Z",
   "annotations":{
      "authorization.k8s.io/decision":"allow",
      "authorization.k8s.io/reason":""
   }
}

```



### How to enable the forwarding?

In order to enable Audit Logs Forwarding you will have to define the target _Stream_ of one of your LDP account where you aim these logs to be forwarded to. The enablement of the forwarding will create a _Subscription_ for this _Stream_.

Note that the forwarding enablement is free of charge, but you will be charged for the usage of Logs Data Platform service as per standard price plan. For LDP pricing refer to [Logs Data Platform product page](https://www.ovhcloud.com/en-ie/logs-data-platform/).

#### Using APIs

You can retrieve the API specification in [OVH API Console](LINK TO API DOC ex: https://api.ovh.com/console-preview/?section=%2Fcloud&branch=v1#post-/cloud/project/-serviceName-/kube/-kubeId-/auditLogs/forward )

1. ##### Retrieve the targeted Stream ID
As you will have to specify the targeted _stream_ of your LDP account where you aim your Kubernetes cluster Audit logs to be forwarded, the first step is to retrieve its id. To do so you will have to use the [LDP API](https://api.ovh.com/console-preview/?section=%2Fdbaas%2Flogs&branch=v1#get-/dbaas/logs/-serviceName-/output/graylog/stream)

  ```
  GET /dbaas/logs/{serviceName}/output/graylog/stream
  ```

  ```
  RESPONSE
  [
  "18bf82a3-f840-4000-85ae-d50bdcc8ea01"
  ]
```
**// UN EXAMPLE AVEC UNE LISTE DE STREAM ? ON N'A PAS D'AUTRES INFO QUE l'ID ??**


2. ##### Create the Subscription
  As per example below the POST request has a payload containing a _streamId_ and _type_.
  - The _streamId_ is the targeted data Stream of your LDP account where you aim your Kubernetes cluster Audit logs to be forwarded( cf. Step 1).
  - The _type_ for Audit Log Forwarding as to be set to "audit".

  ```
  POST /cloud/project/{serviceName}/kube/{kubeId}/ldp-subscription/

  {
      "streamId":"ab51887e-0b98-4752-a514-f2513523a5cd"
      "type":"audit"
  }
  ```

  You will get a response with _operationid_, using it you can retrieve the _subscriptionid_ for further management purposes using [Logs Data Platform read operation endpoint](https://api.ovh.com/console-preview/?section=%2Fdbaas%2Flogs&branch=v1#get-/dbaas/logs/-serviceName-/operation)





#### Using the control panel


You can find your _streamId_, in Logs Data Platform control panel of your account in Data stream" pan when editing a stream:

- Got to the "Data Stream" page of your Logs Data Platform account and "Edit" the target Data Stream

![](RackMultipart20231116-1-zv78wk_html_76b7bd953b1f1133.png)

[_https://www.ovh.com/manager/#/dedicated/dbaas/logs/{ldp-account-id}/streams/home_](https://www.ovh.com/manager/)

- Copy the _streamId_ page of your Logs Data Platform account.

![](RackMultipart20231116-1-zv78wk_html_e11c8656b1f3c011.png)

[_https://www.ovh.com/manager/#/dedicated/dbaas/logs/{ldp-account-id}/streams/{streamid}/edit_](https://www.ovh.com/manager/)

Alternatively, you can retrieve your streamed using Logs Data Platform API:

- List data stream of you Logs Data Platform account

![](RackMultipart20231116-1-zv78wk_html_af843b1817a34f99.png)[/dbaas/logs/{serviceName}/output/graylog/stream](https://api.ovh.com/console-preview/?section=%2Fdbaas%2Flogs&branch=v1)

- Get the details of a data stream

![Shape7](RackMultipart20231116-1-zv78wk_html_1a16ce61a465074.gif)[/dbaas/logs/{serviceName}/output/graylog/stream/{streamId}](https://api.ovh.com/console-preview/?section=%2Fdbaas%2Flogs&branch=v1#get-/dbaas/logs/-serviceName-/output/graylog/stream/-streamId-)

## How to use your Kubernetes Audit logs?

Now that your Kubernetes instance Audit logs are ingested and stored in your Logs Data Platform data stream, you can query your logs and build dashboards to have a graphical representation of your logs using web-based UI of Graylog.

- Retrieve the admin user (\<\> Logs Data Platform service) and its password in your Logs Data Platform account home page.
- Open the Graylog web-ui. You can retrieve le linke in your account home page or using your Access point depending of your account region (for example: Gravelines regions [https://gra1.logs.ovh.com/](https://gra1.logs.ovh.com/) )

![](RackMultipart20231116-1-zv78wk_html_3ec73e763def03cc.png)

[_https://www.ovh.com/manager/#/dedicated/dbaas/logs/ldp-qz-47460/home_](https://www.ovh.com/manager/)

- Login Graylog using your _ **Logs Data Platform service** _ name and **P** _ **assword** _

![](RackMultipart20231116-1-zv78wk_html_5e6d8c3f57668648.png)

[_https://gra1.logs.ovh.com/_](https://gra1.logs.ovh.com/)

- Search your through your logs across the data stream of your Logs Data Platform account. You can refer to [Graylog writing search qyeries documentation](https://go2docs.graylog.org/4-x/making_sense_of_your_log_data/writing_search_queries.html?tocpath=Searching%20Your%20Log%20Data%7C _____ 1) for details on search syntax.

![](RackMultipart20231116-1-zv78wk_html_30710931ae531f7e.png)

For more details about how to use your logs with Logs Data Platform, including:

- how to setup alerts,
- view the logs in real time through a WebSocket,
- build visualization with OpenSearch Dashboards,
- integrate with OpenSearch API
- to connect with Grafana

- refer to following documentation [Logs Data Platform - Visualizing, querying and exploiting your logs](https://help.ovhcloud.com/csm/fr-documentation-observability-logs-data-platform-visualizing-querying-exploiting?id=kb_browse_cat&kb_id=3d4a8129a884a950f07829d7d5c75243&kb_category=00fe0f8829ffe1141e11171b7d895c8c).

## How to manage your subscriptions?

At any point, you can retrieve subscriptions attached to your Logs Data Platform data stream and choose to disable the forwarding by cancelling your subscription on your stream so that your Logs Data Platform stream doesn't receive your audit logs anymore.

Note that this doesn't delete the logs that have been stored prior to the subscription cancellation, as data stored in a logs stream is immutable unless you delete the entire stream.

Currently, you can only manage your subscriptions via Logs Data Platform's API.

The three following Logs Data Platform's API routes respectively allow you to:

- ![Shape9](RackMultipart20231116-1-zv78wk_html_90903f889674de4a.gif) ![Shape8](RackMultipart20231116-1-zv78wk_html_90903f889674de4a.gif)GET: /dbaas/logs/{serviceName}/output/graylog/stream/{streamId}/subscriptionGET: /dbaas/logs/{serviceName}/output/graylog/stream/{streamId}/subscriptionretrieve a list of _subscription IDs_ associated with a specific logs stream based on its _streamID_
- ![Shape10](RackMultipart20231116-1-zv78wk_html_90903f889674de4a.gif)GET: /dbaas/logs/{serviceName}/output/graylog/stream/{streamId}/subscription/{subscriptionId}retrieve the information (such as the _resource type_, in this case Managed Kubernetes, and _resource name_ – the UUID of your ManagedKubernetes cluster) of the service associated with the subscription based on its _subscriptionId._

- ![Shape11](RackMultipart20231116-1-zv78wk_html_50732ca227fdd407.gif)DELETE: /dbaas/logs/{serviceName}/output/graylog/stream/{streamId}/subscription/{subscriptionId}delete a subscription based on its _subscriptionId._

Retrieve these API specification in OVH API console for LDP in [/dbaas/logs](https://api.ovh.com/console-preview/?section=%2Fdbaas%2Flogs&branch=v1)

# Go further

Any feedback or issue using this new forwarding feature during the BETA contact Kubernetes and Logs Data Platform teams through the dedidcated private discord channel : [Kubernetes channel](https://discord.com/channels/850031577277792286/1146847042421932184) on OVHcloud Discord.

5
